name: Newsletter Subscription

on:
  issues:
    types: [opened]
  workflow_dispatch:

jobs:
  subscribe:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.title, 'SUBSCRIBE:')
    steps:
      - name: Extract email
        id: extract
        run: |
          EMAIL=$(echo "${{ github.event.issue.title }}" | sed 's/SUBSCRIBE://' | tr -d ' ')
          echo "email=$EMAIL" >> $GITHUB_OUTPUT
          
      - name: Add to subscribers list
        uses: actions/checkout@v4
        
      - name: Update subscribers
        run: |
          echo "${{ steps.extract.outputs.email }}" >> subscribers.txt
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add subscribers.txt
          git commit -m "Add subscriber: ${{ steps.extract.outputs.email }}"
          git push
          
      - name: Send welcome email (using AgentMail)
        run: |
          curl -X POST https://api.agentmail.to/send \
            -H "Authorization: Bearer ${{ secrets.AGENTMAIL_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "to": "${{ steps.extract.outputs.email }}",
              "from": "widedamage746@agentmail.to",
              "subject": "Welcome to Synthetic Engineer!",
              "body": "Thanks for subscribing! First issue drops Friday. - Klaus"
            }'
            
      - name: Close issue
        uses: peter-evans/close-issue@v3
        with:
          comment: "âœ… Successfully subscribed! Check your inbox."
